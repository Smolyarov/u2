#include "main.h"
#include "mpu9150.hpp"

using namespace chibios_rt;
/*
 ******************************************************************************
 * DEFINES
 ******************************************************************************
 */

/*
 ******************************************************************************
 * EXTERNS
 ******************************************************************************
 */

/*
 ******************************************************************************
 * PROTOTYPES
 ******************************************************************************
 */

/*
 ******************************************************************************
 * GLOBAL VARIABLES
 ******************************************************************************
 */

/*
 ******************************************************************************
 ******************************************************************************
 * LOCAL FUNCTIONS
 ******************************************************************************
 ******************************************************************************
 */

/*
 ******************************************************************************
 * EXPORTED FUNCTIONS
 ******************************************************************************
 */

/**
 *
 */
MPU9150::MPU9150(I2CDriver *i2cdp):
ak(i2cdp, ak8975addr),
mpu(i2cdp, mpu6050addr)
{
  return;
}

/**
 *
 */
msg_t MPU9150::start(void){
  mpu.start();
  ak.start();
  ready = true;
  return MSG_OK;
}

/**
 *
 */
void MPU9150::stop(void){
  ready = false;
  ak.stop();
  mpu.stop();
}

/**
 *
 */
msg_t MPU9150::get(float *acc, float *gyr, float *mag) {

  osalDbgCheck(true == ready);

  msg_t ak_ret = MSG_OK;
  msg_t mpu_ret = MSG_OK;

  if (nullptr != mag)
    ak_ret = ak.get(mag);

  if ((nullptr != acc) || (nullptr != gyr))
    mpu_ret = mpu.get(acc, gyr);

  if ((MSG_OK == ak_ret) && (MSG_OK == mpu_ret))
    return MSG_OK;
  else
    return MSG_RESET;
}

/**
 *
 */
float MPU9150::update_perod(void){
  return mpu.update_perod();
}



