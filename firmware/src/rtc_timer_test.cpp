#include "main.h"

using namespace chibios_rt;

/*
 ******************************************************************************
 * DEFINES
 ******************************************************************************
 */

#define RTC_STEP        65535

/*
 ******************************************************************************
 * EXTERNS
 ******************************************************************************
 */

/*
 ******************************************************************************
 * PROTOTYPES
 ******************************************************************************
 */

static void gptcb(GPTDriver *gptp);

/*
 ******************************************************************************
 * GLOBAL VARIABLES
 ******************************************************************************
 */

static int64_t rtc_value;

/*
 * GPT2 configuration.
 */
static const GPTConfig gptcfg = {
  1000000,    /* 1MHz timer clock.*/
  gptcb,      /* Timer callback.*/
  0,
  0
};

/*
 ******************************************************************************
 ******************************************************************************
 * LOCAL FUNCTIONS
 ******************************************************************************
 ******************************************************************************
 */
/*
 * GPT2 callback.
 */
static void gptcb(GPTDriver *gptp) {
  (void)gptp;

  chSysLockFromISR();
  rtc_value += RTC_STEP;
  chSysUnlockFromISR();
}

/*
 ******************************************************************************
 * EXPORTED FUNCTIONS
 ******************************************************************************
 */

void rtcTimerStart(void) {
  rtc_value = 1411111111;
  rtc_value *= 1000000;

  gptStart(&GPTD6, &gptcfg);
  gptStartContinuous(&GPTD6, RTC_STEP);
}



